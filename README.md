# Simple Authorization Service

Этот проект представляет собой **простой сервис авторизации**, написанный на Go с соблюдением хороших практик и использованием популярного набора инструментов. Код демонстрирует механизмы аутентификации/регистрации, подтверждения учётных записей через одноразовые коды, а также работу с асинхронной отправкой email и миграциями базы данных. Проект легко разворачивается с помощью Docker.

## Основные возможности

1. **Авторизация и регистрация**  
   - Использует **[Gin](https://gin-gonic.com/)** в качестве HTTP-фреймворка (роутинг, middleware).
   - Возможность выдавать **JWT** или **PASETO** для дальнейших запросов к защищённым эндпоинтам.
   - Хранение пользователей в PostgreSQL, валидация полей и проверка учётных данных.

2. **Асинхронная отправка Email**  
   - После регистрации пользователь получает письмо с кодом активации.
   - Отправка письма происходит асинхронно (goroutine), чтобы не блокировать основной поток.

3. **Подтверждение учётной записи через Redis**  
   - Генерируется одноразовый код (OTP), сохраняется в Redis с ограниченным временем жизни (TTL).
   - При активации (ввод кода) сервис проверяет Redis и подтверждает учётку в базе.

4. **Docker и docker-compose**  
   - Имеется **Dockerfile** для сборки Go-приложения.
   - **docker-compose.yml** поднимает PostgreSQL, Redis и само приложение.

5. **Golang-migrate**  
   - SQL-файлы миграций размещены в папке `migrations/`.
   - Позволяет выполнять команды `up`, `down`, `drop` и т. д. для управления схемой БД.

6. **Конфигурация через cleanenv**  
   - YAML-файл + ENV-переменные (ENV имеет приоритет).
   - Настройки для Postgres, Redis, SMTP, порты, логирование и т. д.

7. **Структурированное логирование Zerolog**  
   - JSON-формат логов, различные уровни (debug, info, error).

8. **Gomail**  
   - Отправка писем по SMTP (код подтверждения, приветственные сообщения).
   - Можно хранить SMTP-пароль в переменных окружения.

9. **JWT или PASETO**  
   - Есть возможность (через пакеты в `pkg/tokens`) использовать токены для авторизации.

---

## Структура проекта

```bash
backend/
├── cmd/
│   └── app/
│       └── main.go          # Точка входа (Go)
├── config/
│   └── config.yaml          # Конфигурация
├── internal/
│   ├── adapters/            # Подключение к внешним сервисам (например, EmailAdapter)
│   ├── app/                 # Инициализация и управление жизненным циклом приложения
│   ├── errcode/             # Коды ошибок
│   ├── models/              # Сущности домена (User, ...)
│   ├── repositories/        # Работа с PostgreSQL
│   ├── services/            # Бизнес-логика (UserService и т. д.)
│   └── transport/
│       └── http/            # Gin handlers, маршруты
├── migrations/              # SQL-миграции golang-migrate
├── pkg/
│   ├── app_errors/          # Определения и структуры ошибок
│   ├── async/               # AsyncRunner, goroutines + WaitGroup
│   ├── email/               # Gomail + логика отправки
│   ├── logger/              # Zerolog инициализация
│   ├── postgres/            # Обёртка над pgx
│   ├── redis/               # Redis client
│   ├── tokens/              # JWT/PASETO (по желанию)
│   └── validator/           # Дополнительные функции валидации
├── Dockerfile               # Сборка Go-приложения
├── docker-compose.yml       # Поднимает Postgres, Redis, приложение
├── go.mod
├── go.sum
└── README.md                # Текущее руководство
```
```markdown
## Запуск

**Клонировать репозиторий**:
```bash
git clone https://github.com/username/simple-auth-service.git
cd simple-auth-service
```

**Настроить** `config/config.yaml` (или переменные среды):

- Порт приложения,
- Данные для PostgreSQL,
- Настройки Redis,
- SMTP (host, порт, логин, пароль).

**Собрать и поднять**:
```bash
docker-compose up --build
```
Это запустит:
- Контейнер с PostgreSQL,
- Контейнер с Redis,
- Контейнер с самим приложением (Go + Gin).

**Миграции** (если не запускаются автоматически):
```bash
docker-compose exec api ./migrate -path /app/migrations -database "$DB_SOURCE" up
```

**Проверка**:
- Откройте [http://localhost:8080/health](http://localhost:8080/health) или аналогичный эндпоинт для проверки статуса,
- Зарегистрируйтесь (`POST /register`),
- Получите письмо и введите код подтверждения (`PATCH /users/activate`).

---

## Как это работает

### Регистрация
1. Создаём пользователя в БД (Postgres).
2. Генерируем одноразовый код, сохраняем в Redis (с TTL).
3. Асинхронно отправляем письмо с кодом через Gomail.

### Подтверждение
1. Пользователь вводит код.
2. Сервис проверяет Redis.
3. Активация в БД (флаг `activated = true`).

### Авторизация (опционально JWT/PASETO)
1. При логине генерируем токен.
2. Клиент хранит его (localStorage / cookie) и отправляет в заголовках при запросах.

### Логгирование
- Zerolog выдаёт JSON-логи,
- Можно отслеживать подробности в контейнерных логах.

---

## Асинхронная отправка писем

Для повышения отзывчивости при `POST /register` сервис **сразу** возвращает ответ, а письмо отправляется в горутине через специальный runner (WaitGroup). Таким образом, запрос **не** блокируется во время SMTP‐подключения.

---

## Redis для подтверждения аккаунта

1. В папке `redis` хранится клиент.
2. При генерации кода `Set("activation:"+email, code, ttl)`.
3. При подтверждении `Get("activation:"+email)`.
4. Если код совпал — `activated = true` в БД.

---

## Настройка JWT/PASETO

В папке `pkg/tokens` можно подключить:

- **JWT** — классический вариант (например, [`github.com/golang-jwt/jwt/v4`](https://github.com/golang-jwt/jwt)).
- **PASETO** — более современный вариант (например, [`github.com/o1egl/paseto`](https://github.com/o1egl/paseto)).

Сервис выдаёт токен при логине, а при доступе к защищённым эндпоинтам нужно отправлять `Authorization: Bearer <token>`.

---

## Безопасность

- **Не** храните секреты (SMTP, JWT key) в коде. Используйте ENV.
- При работе с браузером токен можно хранить либо в **localStorage** (проще, но уязвимо для XSS), либо в **HttpOnly-cookie** (безопаснее, но сложнее настройка).

---

## Лицензия

Если не указано иное, код распространяется под **MIT License** или другой свободной лицензией. Вы можете изменить её на любую удобную.

**Enjoy building and improving the Simple Authorization Service!**
